C51 COMPILER V9.59.0.0   PRIVATEMODE                                                       09/19/2018 11:25:18 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE PRIVATEMODE
OBJECT MODULE PLACED IN .\Objects\PrivateMode.obj
COMPILER INVOKED BY: F:\Keil_v5_C51\C51\BIN\C51.EXE ..\Mode\src\PrivateMode.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Protoco
                    -l;..\Mode\inc;..\MyLib\inc;..\Lib\inc;..\User) DEBUG OBJECTEXTEND PRINT(.\Listings\PrivateMode.lst) TABS(2) OBJECT(.\Obj
                    -ects\PrivateMode.obj)

line level    source

   1          #include "STC8A8K32S4A12.h"
   2          
   3          #include "PublicMode.h"
   4          #include "PrivateMode.h"
   5          #include "PublicFunction.h"
   6          #include "Packet.h"
   7          #include "Order.h"
   8          #include "Usart.h"
   9          #include "Gprs.h"
  10          #include "EEPROM.h"
  11          #include "Delay.h"
  12          
  13          #include "string.h"
  14          #include "ctype.h"
  15          
  16          void PrivateMode_Start()
  17          {
  18   1          unsigned long xdata ValveCountDown_New;
  19   1          unsigned long xdata ValveCountDown_Old;
  20   1          AUXR |= 0x10;
  21   1          IapErase(EEPROM_DeviceMode);
  22   1          IapProgram(EEPROM_DeviceMode, MODE_FLOW);
  23   1          StopBool = False;
  24   1          StartBool = False;
  25   1          //DeviceStatus == STATUS_WAITACTIVATION;
  26   1          while (1)
  27   1          {
  28   2      
  29   2              if (HeartPacketBool == True)
  30   2              {
  31   3                  GPRS_SendHeartPacket();
  32   3                  HeartPacketBool = False;
  33   3                  Send_OK_Flag = True;
  34   3              }
  35   2              if ((IapRead(EEPROM_DeviceStatus)) == STATUS_WAITACTIVATION)
  36   2              {
  37   3      
  38   3                  if (Order == COMMAND_SYSTEMINIT)
  39   3                  {
  40   4                      Valve_Switch(OFF);
  41   4                      SystemInit_PacketData();
  42   4                      GPRS_SendData(COMMAND_RECV_SYSTEMINIT, DeviceMode, DeviceStatus); //å‘æœåŠ¡å™¨ä¸Šä¼ æ¨¡å
             -¼åˆ‡æ¢å‘½ä»¤å›žæ‰§
  43   4                      Order = COMMAND_MODESWITCH;
  44   4                      return;
  45   4                  }
  46   3                  else if (Order == COMMAND_ERRORUPLOAD)
  47   3                  {
  48   4                      DeviceMode = IapRead(EEPROM_DeviceMode);
  49   4                      DeviceStatus = IapRead(EEPROM_DeviceStatus);
  50   4                      GPRS_SendData(COMMAND_ERRORUPLOAD, DeviceMode, DeviceStatus);
  51   4                      Order = COMMAND_HEARTBEATPACKET;
  52   4                  }
C51 COMPILER V9.59.0.0   PRIVATEMODE                                                       09/19/2018 11:25:18 PAGE 2   

  53   3              }
  54   2              else
  55   2              {
  56   3                  if (Order == COMMAND_ERRORUPLOAD)
  57   3                  {
  58   4                          DeviceMode = IapRead(EEPROM_DeviceMode);
  59   4                          DeviceStatus = IapRead(EEPROM_DeviceStatus);
  60   4                          GPRS_SendData(COMMAND_ERRORUPLOAD, DeviceMode, DeviceStatus);
  61   4                          Order = COMMAND_HEARTBEATPACKET;
  62   4                  }
  63   3                  else if (Order == COMMAND_DEVICECLOSE) //å…³æœºå‘½ä»¤
  64   3                  {
  65   4                      Valve_Switch(OFF);
  66   4                      DeviceStatus = STATUS_CLOSEDEVICE;
  67   4                      IapErase(EEPROM_DeviceStatus);
  68   4                      IapProgram(EEPROM_DeviceStatus, STATUS_CLOSEDEVICE);
  69   4                      GPRS_SendData(COMMAND_RECV_DEVICECLOSE, MODE_FLOW, STATUS_CLOSEDEVICE); //å‘æœåŠ¡å™¨ä¸Šä
             -¼ å…³æœºå‘½ä»¤å›žæ‰§
  70   4                      Order = COMMAND_HEARTBEATPACKET;
  71   4                  }
  72   3                  else if (Order == COMMAND_DEVICEOPEN) //å¼€æœºå‘½ä»¤
  73   3                  {
  74   4                      if (ValveCountDown > 0)
  75   4                      {
  76   5                          Valve_Switch(ON); //æ‰“å¼€è„‰å†²é˜€
  77   5                          DeviceStatus = STATUS_OPENDEVICE;
  78   5                          IapErase(EEPROM_DeviceStatus);
  79   5                          IapProgram(EEPROM_DeviceStatus, STATUS_OPENDEVICE);
  80   5                      }
  81   4                      else if (ValveCountDown == 0)
  82   4                      {
  83   5                          Valve_Switch(OFF); //å…³é—­è„‰å†²é˜€
  84   5                          DeviceStatus = STATUS_OPENDEVICE;
  85   5                          IapErase(EEPROM_DeviceStatus);
  86   5                          IapProgram(EEPROM_DeviceStatus, STATUS_ARREARAGE);
  87   5                      }
  88   4                      else if (ValveCountDown < 0)
  89   4                      {
  90   5                          Valve_Switch(OFF); //å…³é—­è„‰å†²é˜€
  91   5                          DeviceStatus = STATUS_ARREARAGE;
  92   5                          IapErase(EEPROM_DeviceStatus);
  93   5                          IapProgram(EEPROM_DeviceStatus, STATUS_ARREARAGE);
  94   5                      }
  95   4                      GPRS_SendData(COMMAND_RECV_DEVICEOPEN, MODE_FLOW, DeviceStatus); //å‘æœåŠ¡å™¨ä¸Šä¼ å¼€æœ
             -ºå‘½ä»¤å›žæ‰§
  96   4                      Order = COMMAND_HEARTBEATPACKET;
  97   4                  }
  98   3                  else if (Order == COMMAND_RECHARGE) //å……å€¼å‘½ä»¤
  99   3                  {
 100   4                      ValveCountDown_New = Flow_to_Valve_FlowMode();
 101   4                      ValveCountDown_Old = ValveCountDown;
 102   4                      ValveCountDown = ValveCountDown_Old + ValveCountDown_New;
 103   4                      ValveCountDown_H = (unsigned short)Get_Long_H(ValveCountDown);
 104   4                      ValveCountDown_M1 = (unsigned short)Get_Long_M1(ValveCountDown);
 105   4                      ValveCountDown_M2 = (unsigned short)Get_Long_M2(ValveCountDown);
 106   4                      ValveCountDown_L = (unsigned short)Get_Long_L(ValveCountDown);
 107   4                      IapErase(EEPROM_Vavle);
 108   4                      IapProgram(EEPROM_Vavle, ValveCountDown_H);
 109   4                      IapProgram(EEPROM_Vavle + 1, ValveCountDown_M1);
 110   4                      IapProgram(EEPROM_Vavle + 2, ValveCountDown_M2);
 111   4                      IapProgram(EEPROM_Vavle + 3, ValveCountDown_L);
 112   4      
C51 COMPILER V9.59.0.0   PRIVATEMODE                                                       09/19/2018 11:25:18 PAGE 3   

 113   4                      if (ValveCountDown > 0)
 114   4                      {
 115   5                          Valve_Switch(ON); //æ‰“å¼€è„‰å†²é˜€
 116   5                          DeviceStatus = STATUS_OPENDEVICE;
 117   5                          IapErase(EEPROM_DeviceStatus);
 118   5                          IapProgram(EEPROM_DeviceStatus, STATUS_OPENDEVICE);
 119   5                      }
 120   4                      else if (ValveCountDown == 0)
 121   4                      {
 122   5                          Valve_Switch(OFF); //å…³é—­è„‰å†²é˜€
 123   5                          DeviceStatus = STATUS_OPENDEVICE;
 124   5                          IapErase(EEPROM_DeviceStatus);
 125   5                          IapProgram(EEPROM_DeviceStatus, STATUS_ARREARAGE);
 126   5                      }
 127   4                      else if (ValveCountDown < 0)
 128   4                      {
 129   5                          Valve_Switch(OFF); //å…³é—­è„‰å†²é˜€
 130   5                          DeviceStatus = STATUS_ARREARAGE;
 131   5                          IapErase(EEPROM_DeviceStatus);
 132   5                          IapProgram(EEPROM_DeviceStatus, STATUS_ARREARAGE);
 133   5                      }
 134   4      
 135   4                      GPRS_SendData(COMMAND_RECV_RECHARGE, MODE_FLOW, DeviceStatus); //å‘æœåŠ¡å™¨ä¸Šä¼ è„‰å†²å
             -……å€¼å›žæ‰§
 136   4                      RechargeFlow_01 = 0x00;
 137   4                      RechargeFlow_02 = 0x00;
 138   4                      Order = COMMAND_HEARTBEATPACKET;
 139   4                  }
 140   3                  else if (Order == COMMAND_DEVICEINFOR) //æŸ¥è¯¢è®¾å¤‡ä¿¡æ¯
 141   3                  {
 142   4                      DeviceMode = IapRead(EEPROM_DeviceMode);
 143   4                      DeviceStatus = IapRead(EEPROM_DeviceStatus);
 144   4                      GPRS_SendData(COMMAND_RECV_DEVICEINFOR, DeviceMode, DeviceStatus); //å‘æœåŠ¡å™¨ä¸Šä¼ æ¨¡
             -å¼åˆ‡æ¢å›žæ‰§
 145   4                      Order = COMMAND_HEARTBEATPACKET;
 146   4                      // return;
 147   4                  }
 148   3                  else if (Order == COMMAND_RECOVERY) //æ¢å¤å‡ºåŽ‚è®¾ç½®
 149   3                  {
 150   4                      Valve_Switch(OFF);
 151   4                      Recovery_PacketData();
 152   4                      GPRS_SendData(COMMAND_RECV_RECOVERY, DeviceMode, DeviceStatus); //å‘æœåŠ¡å™¨ä¸Šä¼ æ¢å¤
             -å‡ºåŽ‚è®¾ç½®å›žæ‰§
 153   4                      Order = COMMAND_HEARTBEATPACKET;
 154   4                      return;
 155   4                  }
 156   3                  else if (Order == COMMAND_SYSTEMINIT) //æ›´æ¢æ¨¡å¼
 157   3                  {
 158   4                      Valve_Switch(OFF);
 159   4                      SystemInit_PacketData();
 160   4                      GPRS_SendData(COMMAND_RECV_SYSTEMINIT, DeviceMode, DeviceStatus); //å‘æœåŠ¡å™¨ä¸Šä¼ æ¨¡å
             -¼åˆ‡æ¢å‘½ä»¤å›žæ‰§
 161   4                      Order = COMMAND_MODESWITCH;
 162   4                      return;
 163   4                  }
 164   3                  else if (Order == COMMAND_DEVICELOCK) //æœºå™¨é”å®šå‘½ä»¤
 165   3                  {
 166   4                      //Valve_Switch(Lock); //ç¬¬ä¸€æ¬¡æŽ¥æ”¶æœºå™¨é”å®šå‘½ä»¤ï¼Œå…³é—­è„‰å†²é˜€ï¼Œç¬¬äºŒæ¬¡æŽ¥
             -åˆ°æœºå™¨é”å®šå‘½ä»¤ï¼Œæ‰“å¼€è„‰å†²é˜€
 167   4                      if (Lock == ON)
 168   4                      {
 169   5                          Valve_Switch(OFF);
C51 COMPILER V9.59.0.0   PRIVATEMODE                                                       09/19/2018 11:25:18 PAGE 4   

 170   5                          DeviceStatus = STATUS_LOCKDEVICE; //å…³é—­è„‰å†²é˜€
 171   5                          IapErase(EEPROM_DeviceStatus);
 172   5                          IapProgram(EEPROM_DeviceStatus, STATUS_LOCKDEVICE);
 173   5                          GPRS_SendData(COMMAND_RECV_DEVICELOCK, MODE_FLOW, DeviceStatus); //å‘æœåŠ¡å™¨ä¸Šä¼ æ
             -œºå™¨é”å®šå›žæ‰§
 174   5                          Order = COMMAND_HEARTBEATPACKET;
 175   5                          Lock = OFF;
 176   5                      }
 177   4                      else if (Lock == OFF)
 178   4                      {
 179   5                          if (ValveCountDown > 0)
 180   5                          {
 181   6                              Valve_Switch(ON); //æ‰“å¼€è„‰å†²é˜€
 182   6                              DeviceStatus = STATUS_OPENDEVICE;
 183   6                              IapErase(EEPROM_DeviceStatus);
 184   6                              IapProgram(EEPROM_DeviceStatus, STATUS_OPENDEVICE);
 185   6                          }
 186   5                          else if (ValveCountDown == 0)
 187   5                          {
 188   6                              Valve_Switch(OFF); //å…³é—­è„‰å†²é˜€
 189   6                              DeviceStatus = STATUS_OPENDEVICE;
 190   6                              IapErase(EEPROM_DeviceStatus);
 191   6                              IapProgram(EEPROM_DeviceStatus, STATUS_ARREARAGE);
 192   6                          }
 193   5                          else if (ValveCountDown < 0)
 194   5                          {
 195   6                              Valve_Switch(OFF); //å…³é—­è„‰å†²é˜€
 196   6                              DeviceStatus = STATUS_ARREARAGE;
 197   6                              IapErase(EEPROM_DeviceStatus);
 198   6                              IapProgram(EEPROM_DeviceStatus, STATUS_ARREARAGE);
 199   6                          }
 200   5                          GPRS_SendData(COMMAND_RECV_DEVICELOCK, MODE_FLOW, DeviceStatus); //å‘æœåŠ¡å™¨ä¸Šä¼ æ
             -œºå™¨é”å®šå›žæ‰§
 201   5                          Order = COMMAND_HEARTBEATPACKET;
 202   5                          Lock = ON;
 203   5                      }
 204   4                  }
 205   3                  if (StartBool == True)
 206   3                  {
 207   4                      if (ValveCountDown > 0)
 208   4                      {
 209   5                          Valve_Switch(ON); //æ‰“å¼€è„‰å†²é˜€
 210   5                          DeviceStatus = STATUS_OPENDEVICE;
 211   5                          IapErase(EEPROM_DeviceStatus);
 212   5                          IapProgram(EEPROM_DeviceStatus, STATUS_OPENDEVICE);
 213   5                      }
 214   4                      else if (ValveCountDown == 0)
 215   4                      {
 216   5                          Valve_Switch(OFF); //å…³é—­è„‰å†²é˜€
 217   5                          DeviceStatus = STATUS_OPENDEVICE;
 218   5                          IapErase(EEPROM_DeviceStatus);
 219   5                          IapProgram(EEPROM_DeviceStatus, STATUS_ARREARAGE);
 220   5                      }
 221   4                      else if (ValveCountDown < 0)
 222   4                      {
 223   5                          Valve_Switch(OFF); //å…³é—­è„‰å†²é˜€
 224   5                          DeviceStatus = STATUS_ARREARAGE;
 225   5                          IapErase(EEPROM_DeviceStatus);
 226   5                          IapProgram(EEPROM_DeviceStatus, STATUS_ARREARAGE);
 227   5                      }
 228   4                      StartBool = False;
 229   4                  }
C51 COMPILER V9.59.0.0   PRIVATEMODE                                                       09/19/2018 11:25:18 PAGE 5   

 230   3                  if (StopBool == True) //ç”¨æ°´åŒæ­¥å‘½ä»¤
 231   3                  {
 232   4                      if (ValveCountDown > 0)
 233   4                      {
 234   5                          Valve_Switch(ON); //æ‰“å¼€è„‰å†²é˜€
 235   5                          DeviceStatus = STATUS_OPENDEVICE;
 236   5                          IapErase(EEPROM_DeviceStatus);
 237   5                          IapProgram(EEPROM_DeviceStatus, STATUS_OPENDEVICE);
 238   5                      }
 239   4                      else if (ValveCountDown == 0)
 240   4                      {
 241   5                          Valve_Switch(OFF); //å…³é—­è„‰å†²é˜€
 242   5                          DeviceStatus = STATUS_OPENDEVICE;
 243   5                          IapErase(EEPROM_DeviceStatus);
 244   5                          IapProgram(EEPROM_DeviceStatus, STATUS_ARREARAGE);
 245   5                      }
 246   4                      else if (ValveCountDown < 0)
 247   4                      {
 248   5                          Valve_Switch(OFF); //å…³é—­è„‰å†²é˜€
 249   5                          DeviceStatus = STATUS_ARREARAGE;
 250   5                          IapErase(EEPROM_DeviceStatus);
 251   5                          IapProgram(EEPROM_DeviceStatus, STATUS_ARREARAGE);
 252   5                      }
 253   4                      ValveCountDown_H = Get_Long_H(ValveCountDown);
 254   4                      ValveCountDown_M1 = Get_Long_M1(ValveCountDown);
 255   4                      ValveCountDown_M2 = Get_Long_M2(ValveCountDown);
 256   4                      ValveCountDown_L = Get_Long_L(ValveCountDown);
 257   4      
 258   4                      IapErase(EEPROM_Vavle);
 259   4                      IapProgram(EEPROM_Vavle, ValveCountDown_H);
 260   4                      IapProgram(EEPROM_Vavle + 1, ValveCountDown_M1);
 261   4                      IapProgram(EEPROM_Vavle + 2, ValveCountDown_M2);
 262   4                      IapProgram(EEPROM_Vavle + 3, ValveCountDown_L);
 263   4      
 264   4                      ValveAll_H = Get_Long_H(ValveAll);
 265   4                      ValveAll_M1 = Get_Long_M1(ValveAll);
 266   4                      ValveAll_M2 = Get_Long_M2(ValveAll);
 267   4                      ValveAll_L = Get_Long_L(ValveAll);
 268   4      
 269   4                      IapErase(EEPROM_VavleALL);
 270   4                      IapProgram(EEPROM_Vavle, ValveAll_H);
 271   4                      IapProgram(EEPROM_Vavle + 1, ValveAll_M1);
 272   4                      IapProgram(EEPROM_Vavle + 2, ValveAll_M2);
 273   4                      IapProgram(EEPROM_Vavle + 3, ValveAll_L);
 274   4      
 275   4                      GPRS_SendData(COMMAND_USEWATERUPLOAD, DeviceMode, DeviceStatus); //å‘æœåŠ¡å™¨ä¸Šä¼ ç”¨æ°
             -´åŒæ­¥å‘½ä»¤
 276   4                      StopBool = False;
 277   4                  }
 278   3              }
 279   2              if ((RECV_Return("CLOSED", NULL) == True) || (RECV_Return_Special("CLOSED", NULL) == True))
 280   2              {
 281   3                  GPRS_ConnectClose();
 282   3                  GPRS_ConnectCreat(IP, Port);
 283   3                  Send_OK_Flag = True;
 284   3                  Order = COMMAND_MODESWITCH;
 285   3                  Clear_Buf(Rx_Buffer_AT);
 286   3                  Clear_Buf(Rx_Buffer);
 287   3                  return;
 288   3              }
 289   2              if ((RECV_Return("PDP:", NULL) == True) || (RECV_Return_Special("PDP:", NULL) == True))
 290   2              {
C51 COMPILER V9.59.0.0   PRIVATEMODE                                                       09/19/2018 11:25:18 PAGE 6   

 291   3                  GPRS_ConnectClose();
 292   3                  GPRS_ConnectCreat(IP, Port);
 293   3                  Send_OK_Flag = True;
 294   3                  Order = COMMAND_MODESWITCH;
 295   3                  Clear_Buf(Rx_Buffer_AT);
 296   3                  Clear_Buf(Rx_Buffer);
 297   3                  return;
 298   3              }
 299   2          }
 300   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1691    ----
   CONSTANT SIZE    =     36    ----
   XDATA SIZE       =   ----       8
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
