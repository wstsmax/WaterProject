C51 COMPILER V9.59.0.0   GPRS                                                              09/26/2018 15:39:21 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE GPRS
OBJECT MODULE PLACED IN .\Objects\Gprs.obj
COMPILER INVOKED BY: F:\Keil_v5_C51\C51\BIN\C51.EXE ..\MyLib\src\Gprs.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Protocol;..\M
                    -ode\inc;..\MyLib\inc;..\Lib\inc;..\User) DEBUG OBJECTEXTEND PRINT(.\Listings\Gprs.lst) TABS(2) OBJECT(.\Objects\Gprs.obj
                    -)

line level    source

   1          #include "STC8A8K32S4A12.h"
   2          
   3          #include "Gprs.h"
   4          #include "PublicFunction.h"
   5          #include "Usart.h"
   6          #include "Order.h"
   7          #include "Packet.h"
   8          #include "Delay.h"
   9          #include "EEPROM.h"
  10          
  11          #include "stdlib.h"
  12          #include "string.h"
  13          
  14          int RECV_Return(char *Recv1, char *Recv2)
  15          {
  16   1        if ((Recv1 == 0) && (Recv2 == 0)) //Â¶ÇÊûúRecv1ÔºåRecv2‰∏∫NULL
  17   1        {
  18   2          return True;
  19   2        }
  20   1        if ((Recv1 != 0) && (Recv2 != 0)) //Â¶ÇÊûúRecv1ÔºåRecv2‰∏ç‰∏∫NULL
  21   1        {
  22   2          if ((strstr(Rx_Buffer_AT, Recv1) && strstr(Rx_Buffer_AT, Recv2)) != NULL) //Rx_Buffer‰∏≠ÊòØÂê¶ÂêåÊó∂ÂåÖÂ
             -ê´Recv1ÔºåRecv2
  23   2            return True;
  24   2          else
  25   2            return False;
  26   2        }
  27   1        else if (Recv1 != 0) //Â¶ÇÊûúRecv1‰∏ç‰∏∫NULL
  28   1        {
  29   2          if (strstr(Rx_Buffer_AT, Recv1) != NULL) //Rx_Buffer‰∏≠ÊòØÂê¶ÂåÖÂê´Recv1
  30   2            return True;
  31   2          else
  32   2            return False;
  33   2        }
  34   1        else //Â¶ÇÊûúRecv1‰∏ç‰∏∫NULL
  35   1        {
  36   2          if (strstr(Rx_Buffer_AT, Recv2) != NULL) //Rx_Buffer‰∏≠ÊòØÂê¶ÂåÖÂê´Recv2
  37   2            return True;
  38   2          else
  39   2            return False;
  40   2        }
  41   1      }
  42          
  43          int RECV_Return_Special(char *Recv1, char *Recv2)
  44          {
  45   1        if ((Recv1 == 0) && (Recv2 == 0)) //Â¶ÇÊûúRecv1ÔºåRecv2‰∏∫NULL
  46   1        {
  47   2          return True;
  48   2        }
  49   1        if ((Recv1 != 0) && (Recv2 != 0)) //Â¶ÇÊûúRecv1ÔºåRecv2‰∏ç‰∏∫NULL
  50   1        {
  51   2          if ((strstr(Rx_Buffer, Recv1) && strstr(Rx_Buffer, Recv2)) != NULL) //Rx_Buffer‰∏≠ÊòØÂê¶ÂêåÊó∂ÂåÖÂê´Recv
             -1ÔºåRecv2
C51 COMPILER V9.59.0.0   GPRS                                                              09/26/2018 15:39:21 PAGE 2   

  52   2            return True;
  53   2          else
  54   2            return False;
  55   2        }
  56   1        else if (Recv1 != 0) //Â¶ÇÊûúRecv1‰∏ç‰∏∫NULL
  57   1        {
  58   2          if (strstr(Rx_Buffer, Recv1) != NULL) //Rx_Buffer‰∏≠ÊòØÂê¶ÂåÖÂê´Recv1
  59   2            return True;
  60   2          else
  61   2            return False;
  62   2        }
  63   1        else //Â¶ÇÊûúRecv1‰∏ç‰∏∫NULL
  64   1        {
  65   2          if (strstr(Rx_Buffer, Recv2) != NULL) //Rx_Buffer‰∏≠ÊòØÂê¶ÂåÖÂê´Recv2
  66   2            return True;
  67   2          else
  68   2            return False;
  69   2        }
  70   1      }
  71          
  72          void GPRS_Init()
  73          {
  74   1        Uart1_Init(); //ÂàùÂßãÂåñ‰∏≤Âè£1
  75   1        P35 = 0;
  76   1        Delay_S(1);
  77   1        Delay_MS(200);
  78   1        P35 = 1;
  79   1      }
  80          void GPRS_Mode(void)
  81          {
  82   1        Clear_Buf(Rx_Buffer_AT);         //Ê∏ÖÁ©∫Êé•Êî∂ÁºìÂÜ≤Âå∫
  83   1        Uart1_Send_Data("AT\n");         //‰∏≤Âè£ÂèëÈÄÅ "AT"
  84   1        Delay_MS(500);               //Âª∂Êó∂500ÊØ´ÁßíÔºà0.5ÁßíÔºâ
  85   1        while (RECV_Return("OK", NULL) == False) //Ê£ÄÊµãÊé•ÂèóÁºìÂÜ≤Âå∫‰∏≠ÊòØÂê¶ÂåÖÂê´"OK"ÔºåÂ¶ÇÊûú‰∏çÂåÖÂê´ÊâßË
             -°å‰∏ãÂàóËØ≠Âè•
  86   1        {
  87   2          Clear_Buf(Rx_Buffer_AT); //Ê∏ÖÁ©∫Êé•Êî∂ÁºìÂÜ≤Âå∫
  88   2          Uart1_Send_Data("AT\n"); //‰∏≤Âè£ÂèëÈÄÅ "AT"
  89   2          Delay_MS(500);       //Âª∂Êó∂500ÊØ´ÁßíÔºà0.5ÁßíÔºâ
  90   2                       //Uart2_Send_Data(Rx_Buffer);
  91   2        }
  92   1        Clear_Buf(Rx_Buffer_AT);           //Ê∏ÖÁ©∫Êé•Êî∂ÁºìÂÜ≤Âå∫
  93   1        Uart1_Send_Data("AT+CPIN?\r\n");       //‰∏≤Âè£ÂèëÈÄÅ "AT+CPIN?"
  94   1        Delay_MS(500);                 //Âª∂Êó∂500ÊØ´ÁßíÔºà0.5ÁßíÔºâ
  95   1        while (RECV_Return("+CPIN:", "OK") == False) //Ê£ÄÊµãÊé•ÂèóÁºìÂÜ≤Âå∫‰∏≠ÊòØÂê¶ÂåÖÂê´"+CPIN: READY"Âíå"OK"Ô
             -ºåÂ¶ÇÊûú‰∏çÂåÖÂê´ÊâßË°å‰∏ãÂàóËØ≠Âè•
  96   1        {
  97   2          Clear_Buf(Rx_Buffer_AT);     //Ê∏ÖÁ©∫Êé•Êî∂ÁºìÂÜ≤Âå∫
  98   2          Uart1_Send_Data("AT+CPIN?\r\n"); //‰∏≤Âè£ÂèëÈÄÅ "AT+CPIN?"
  99   2          Delay_MS(500);           //Âª∂Êó∂500ÊØ´ÁßíÔºà0.5ÁßíÔºâ
 100   2        }
 101   1        Clear_Buf(Rx_Buffer_AT);           //Ê∏ÖÁ©∫Êé•Êî∂ÁºìÂÜ≤Âå∫
 102   1        Uart1_Send_Data("AT+CREG?\r\n");       //‰∏≤Âè£ÂèëÈÄÅ "AT+CREG?"
 103   1        Delay_MS(500);                 //Âª∂Êó∂500ÊØ´ÁßíÔºà0.5ÁßíÔºâ
 104   1        while (RECV_Return("+CREG:", NULL) == False) //Ê£ÄÊµãÊé•ÂèóÁºìÂÜ≤Âå∫‰∏≠ÊòØÂê¶ÂåÖÂê´"CREG:"ÔºåÂ¶ÇÊûú‰∏çÂåÖ
             -Âê´ÊâßË°å‰∏ãÂàóËØ≠Âè•
 105   1        {
 106   2          Clear_Buf(Rx_Buffer_AT);     //Ê∏ÖÁ©∫Êé•Êî∂ÁºìÂÜ≤Âå∫
 107   2          Uart1_Send_Data("AT+CREG?\r\n"); //‰∏≤Âè£ÂèëÈÄÅ "AT+CREG?"
 108   2          Delay_MS(500);           //Âª∂Êó∂500ÊØ´ÁßíÔºà0.5ÁßíÔºâ
 109   2        }
 110   1        //Clear_Buf(Rx_Buffer_AT); //Ê∏ÖÁ©∫Êé•Êî∂ÁºìÂÜ≤Âå∫
C51 COMPILER V9.59.0.0   GPRS                                                              09/26/2018 15:39:21 PAGE 3   

 111   1        //Clear_Buf(Rx_Buffer_AT); //Ê∏ÖÁ©∫Êé•Êî∂ÁºìÂÜ≤Âå∫
 112   1        Clear_Buf(Rx_Buffer_AT);         //Ê∏ÖÁ©∫Êé•Êî∂ÁºìÂÜ≤Âå∫
 113   1        Uart1_Send_Data("AT+CIPQSEND=0\r\n"); //‰∏≤Âè£ÂèëÈÄÅ "AT+CREG?"
 114   1        Delay_MS(500);               //Âª∂Êó∂500ÊØ´ÁßíÔºà0.5ÁßíÔºâ
 115   1        while (RECV_Return("OK", NULL) == False) //Ê£ÄÊµãÊé•ÂèóÁºìÂÜ≤Âå∫‰∏≠ÊòØÂê¶ÂåÖÂê´"CREG:"ÔºåÂ¶ÇÊûú‰∏çÂåÖÂê´Ê
             -âßË°å‰∏ãÂàóËØ≠Âè•
 116   1        {
 117   2          Clear_Buf(Rx_Buffer_AT);        //Ê∏ÖÁ©∫Êé•Êî∂ÁºìÂÜ≤Âå∫
 118   2          Uart1_Send_Data("AT+CIPQSEND=0\r\n"); //‰∏≤Âè£ÂèëÈÄÅ "AT+CREG?"
 119   2          Delay_MS(500);              //Âª∂Êó∂500ÊØ´ÁßíÔºà0.5ÁßíÔºâ
 120   2        }
 121   1        Clear_Buf(Rx_Buffer_AT); //Ê∏ÖÁ©∫Êé•Êî∂ÁºìÂÜ≤Âå∫
 122   1      }
 123          
 124          void GPRS_ConnectCreat(char *ServerIP, char *ServerPort)
 125          {
 126   1        Uart1_Send_Data("AT+CIPSTART="); //‰∏≤Âè£ÂèëÈÄÅ "AT+CIPSTART="
 127   1        Uart1_Send(34);          //‰∏≤Âè£ÂèëÈÄÅ "
 128   1        Uart1_Send_Data("TCP");      //‰∏≤Âè£ÂèëÈÄÅ "TCP"
 129   1        Uart1_Send(34);          //‰∏≤Âè£ÂèëÈÄÅ "
 130   1        Uart1_Send(44);          //‰∏≤Âè£ÂèëÈÄÅ ,
 131   1        Uart1_Send(34);          //‰∏≤Âè£ÂèëÈÄÅ "
 132   1        Uart1_Send_Data(ServerIP);     //‰∏≤Âè£ÂèëÈÄÅ ServerIP
 133   1        Uart1_Send(34);          //‰∏≤Âè£ÂèëÈÄÅ "
 134   1        Uart1_Send(44);          //‰∏≤Âè£ÂèëÈÄÅ ,
 135   1        Uart1_Send(34);          //‰∏≤Âè£ÂèëÈÄÅ "
 136   1        Uart1_Send_Data(ServerPort);   //‰∏≤Âè£ÂèëÈÄÅ ServerPort
 137   1        Uart1_Send(34);          //‰∏≤Âè£ÂèëÈÄÅ "
 138   1        Uart1_Send_Data("\r\n");     //‰∏≤Âè£ÂèëÈÄÅ "\r\n"
 139   1        Delay_MS(5000);          //Âª∂Êó∂2000ÊØ´ÁßíÔºà2ÁßíÔºâ
 140   1        while (1)            //Ê£ÄÊµãÊé•ÂèóÁºìÂÜ≤Âå∫‰∏≠ÊòØÂê¶ÂåÖÂê´"CONNECT OK"ÔºåÂ¶ÇÊûú‰∏çÂåÖÂê´ÊâßË°å‰∏ãÂàóËØ≠Âè•
 141   1        {
 142   2          if (RECV_Return("CONNECT OK", NULL) == True)
 143   2          {
 144   3            Clear_Buf(Rx_Buffer_AT);
 145   3            return;
 146   3          }
 147   2          if (RECV_Return("ALREADY CONNECT", NULL) == True)
 148   2          {
 149   3            Clear_Buf(Rx_Buffer_AT);
 150   3            return;
 151   3          }
 152   2          if (RECV_Return("CONNECT FAIL", NULL) == True)
 153   2          {
 154   3            Clear_Buf(Rx_Buffer_AT);     //Ê∏ÖÁ©∫Êé•Êî∂ÁºìÂÜ≤Âå∫
 155   3            Uart1_Send_Data("AT+CIPSTART="); //‰∏≤Âè£ÂèëÈÄÅ AT+CIPSTART="
 156   3            Uart1_Send(34);          //‰∏≤Âè£ÂèëÈÄÅ "
 157   3            Uart1_Send_Data("TCP");      //‰∏≤Âè£ÂèëÈÄÅ "TCP"
 158   3            Uart1_Send(34);          //‰∏≤Âè£ÂèëÈÄÅ "
 159   3            Uart1_Send(44);          //‰∏≤Âè£ÂèëÈÄÅ ,
 160   3            Uart1_Send(34);          //‰∏≤Âè£ÂèëÈÄÅ "
 161   3            Uart1_Send_Data(ServerIP);     //‰∏≤Âè£ÂèëÈÄÅ ServerIP
 162   3            Uart1_Send(34);          //‰∏≤Âè£ÂèëÈÄÅ "
 163   3            Uart1_Send(44);          //‰∏≤Âè£ÂèëÈÄÅ ,
 164   3            Uart1_Send(34);          //‰∏≤Âè£ÂèëÈÄÅ "
 165   3            Uart1_Send_Data(ServerPort);   //‰∏≤Âè£ÂèëÈÄÅ ServerPort
 166   3            Uart1_Send(34);          //‰∏≤Âè£ÂèëÈÄÅ "
 167   3            Uart1_Send_Data("\r\n");     //‰∏≤Âè£ÂèëÈÄÅ "\r\n"
 168   3                             //Delay_MS(5000);           //Âª∂Êó∂2000ÊØ´ÁßíÔºà2ÁßíÔºâ
 169   3                             //Uart2_Send_Data(Rx_Buffer);
 170   3                             //return;
 171   3          }
C51 COMPILER V9.59.0.0   GPRS                                                              09/26/2018 15:39:21 PAGE 4   

 172   2        }
 173   1        //Clear_Buf(Rx_Buffer_AT); //Ê∏ÖÁ©∫Êé•Êî∂ÁºìÂÜ≤Âå∫
 174   1      }
 175          
 176          void GPRS_ConnectClose(void)
 177          {
 178   1        Clear_Buf(Rx_Buffer);
 179   1        Uart1_Send_Data("AT+CIPSHUT\r\n");
 180   1        Delay_MS(5000);
 181   1        while (RECV_Return("SHUT OK", NULL) == False)
 182   1        {
 183   2          Clear_Buf(Rx_Buffer);
 184   2          Uart1_Send_Data("AT+CIPSHUT\r\n");
 185   2          Delay_MS(5000);
 186   2        }
 187   1        Clear_Buf(Rx_Buffer);
 188   1      }
 189          
 190          void GPRS_SendData(char Command, char Mode, char Status)
 191          {
 192   1        int Send_Num = 0;
 193   1        int xdata HCheck;    //Ê†°È™å‰ΩçÈ´ò‰Ωç
 194   1        int xdata LCheck;    //Ê†°È™å‰Ωç‰Ωé‰Ωç
 195   1        Clear_Buf(Rx_Buffer_AT); //Ê∏ÖÁ©∫Êé•Êî∂ÁºìÂÜ≤Âå∫
 196   1        Send_OK_Flag = False;
 197   1        GPRS_Signal();
 198   1        Uart1_Send_Data("AT+CIPSEND=36\r\n"); //‰∏≤Âè£ÂèëÈÄÅ "AT+CIPSEND"
 199   1        //Delay_MS(2000);             //Âª∂Êó∂500ÊØ´ÁßíÔºà0.5ÁßíÔºâ
 200   1        while (1) //Ê£ÄÊµãÊé•ÂèóÁºìÂÜ≤Âå∫‰∏≠ÊòØÂê¶ÂåÖÂê´">"ÔºåÂ¶ÇÊûú‰∏çÂåÖÂê´ÊâßË°å‰∏ãÂàóËØ≠Âè•
 201   1        {
 202   2          if (RECV_Return(">", NULL) == True)
 203   2          {
 204   3            goto SENDFLAG;
 205   3          }
 206   2          if ((RECV_Return("ERROR", NULL) == True) || (RECV_Return_Special("ERROR", NULL) == True))
 207   2          {
 208   3            GPRS_ConnectClose();
 209   3            GPRS_ConnectCreat(IP, Port);
 210   3            IapRead(EEPROM_DeviceMode);
 211   3            IapRead(EEPROM_DeviceStatus);
 212   3            GPRS_SendData(COMMAND_HEARTBEATPACKET, DeviceMode, DeviceStatus);
 213   3            Clear_Buf(Rx_Buffer_AT);
 214   3            Clear_Buf(Rx_Buffer);
 215   3          }
 216   2          //Clear_Buf(Rx_Buffer_AT);        //Ê∏ÖÁ©∫Êé•Êî∂ÁºìÂÜ≤Âå∫
 217   2          //Uart1_Send_Data("AT+CIPSEND=36\r\n"); //‰∏≤Âè£ÂèëÈÄÅ "AT+CIPSEND"
 218   2          //Delay_MS(2000);
 219   2        }
 220   1      SENDFLAG:
 221   1        Clear_Buf(Rx_Buffer_AT); //Ê∏ÖÁ©∫Êé•Êî∂ÁºìÂÜ≤Âå∫
 222   1        Clear_Buf(Rx_Buffer);
 223   1        DeviceID_01 = IapRead(EEPROM_DeviceID);
 224   1        DeviceID_02 = IapRead(EEPROM_DeviceID + 1);
 225   1        DeviceID_03 = IapRead(EEPROM_DeviceID + 2);
 226   1        DeviceID_04 = IapRead(EEPROM_DeviceID + 3);
 227   1        Order = Command;     //ÂèëÈÄÅÂëΩ‰ª§
 228   1        DeviceMode = Mode;   //ÂèëÈÄÅËÆæÂ§áÊ®°Âºè
 229   1        DeviceStatus = Status; //ÂèëÈÄÅËÆæÂ§áÁä∂ÊÄÅ
 230   1        Valve_to_Flow();     //Â∞ÜËÑâÂÜ≤ËΩ¨Êç¢‰∏∫ÊµÅÈáè
 231   1        ICCID1_01 = IapRead(EEPROM_ICCID);
 232   1        ICCID1_02 = IapRead(EEPROM_ICCID + 1);
 233   1        ICCID2_01 = IapRead(EEPROM_ICCID + 2);
C51 COMPILER V9.59.0.0   GPRS                                                              09/26/2018 15:39:21 PAGE 5   

 234   1        ICCID2_02 = IapRead(EEPROM_ICCID + 3);
 235   1        ICCID3_01 = IapRead(EEPROM_ICCID + 4);
 236   1        ICCID3_02 = IapRead(EEPROM_ICCID + 5);
 237   1        ICCID4_01 = IapRead(EEPROM_ICCID + 6);
 238   1        ICCID4_02 = IapRead(EEPROM_ICCID + 7);
 239   1        ICCID5_01 = IapRead(EEPROM_ICCID + 8);
 240   1        ICCID5_02 = IapRead(EEPROM_ICCID + 9);
 241   1        Get_Check(&HCheck, &LCheck); //ËÆ°ÁÆóÊ†°È™å‰Ωç
 242   1        Check_01 = HCheck;       //‰øùÂ≠òÊ†°È™å‰ΩçÈ´ò‰Ωç
 243   1        Check_02 = LCheck;       //‰øùÂ≠òÊ†°È™å‰Ωç‰Ωé‰Ωç
 244   1        Uart1_Send(DeviceID_01);   //‰∏≤Âè£ÂèëÈÄÅ ËÆæÂ§áID_01
 245   1        Uart1_Send(DeviceID_02);   //‰∏≤Âè£ÂèëÈÄÅ ËÆæÂ§áID_02
 246   1        Uart1_Send(DeviceID_03);   //‰∏≤Âè£ÂèëÈÄÅ ËÆæÂ§áID_03
 247   1        Uart1_Send(DeviceID_04);   //‰∏≤Âè£ÂèëÈÄÅ ËÆæÂ§áID_04
 248   1        Uart1_Send(DeviceMode);    //‰∏≤Âè£ÂèëÈÄÅ ËÆæÂ§áËÆ°Ë¥πÊ®°Âºè
 249   1        Uart1_Send(Order);       //‰∏≤Âè£ÂèëÈÄÅ ÂëΩ‰ª§
 250   1        Uart1_Send(DeviceStatus); //‰∏≤Âè£ÂèëÈÄÅ ËÆæÂ§áÁä∂ÊÄÅ
 251   1        Uart1_Send(DeviceFlow_01);   //‰∏≤Âè£ÂèëÈÄÅ Êú¨Ê¨°Ê∂àË¥πÊµÅÈáè_01
 252   1        Uart1_Send(DeviceFlow_02);   //‰∏≤Âè£ÂèëÈÄÅ Êú¨Ê¨°Ê∂àË¥πÊµÅÈáè_02
 253   1        Uart1_Send(RechargeFlow_01); //‰∏≤Âè£ÂèëÈÄÅ ÂÖÖÂÄºÊµÅÈáè_01
 254   1        Uart1_Send(RechargeFlow_02); //‰∏≤Âè£ÂèëÈÄÅ ÂÖÖÂÄºÊµÅÈáè_02
 255   1        Uart1_Send(RechargeDay_01);  //‰∏≤Âè£ÂèëÈÄÅ ÂÖÖÂÄºÂ§©Êï∞_01
 256   1        Uart1_Send(RechargeDay_02);  //‰∏≤Âè£ÂèëÈÄÅ ÂÖÖÂÄºÂ§©Êï∞_02
 257   1        Uart1_Send(SurplusFlow_01);  //‰∏≤Âè£ÂèëÈÄÅ Ââ©‰ΩôÊµÅÈáè_01
 258   1        Uart1_Send(SurplusFlow_02);  //‰∏≤Âè£ÂèëÈÄÅ Ââ©‰ΩôÊµÅÈáè_02
 259   1        Uart1_Send(SurplusDay_01);   //‰∏≤Âè£ÂèëÈÄÅ Ââ©‰ΩôÂ§©Êï∞_01
 260   1        Uart1_Send(SurplusDay_02);   //‰∏≤Âè£ÂèëÈÄÅ Ââ©‰ΩôÂ§©Êï∞_02
 261   1        Uart1_Send(UsedFlow_01);   //‰∏≤Âè£ÂèëÈÄÅ Â∑≤‰ΩøÁî®ÊµÅÈáè_01
 262   1        Uart1_Send(UsedFlow_02);   //‰∏≤Âè£ÂèëÈÄÅ Â∑≤‰ΩøÁî®ÊµÅÈáè_02
 263   1        Uart1_Send(UsedDay_01);    //‰∏≤Âè£ÂèëÈÄÅ Â∑≤‰ΩøÁî®Â§©Êï∞_01
 264   1        Uart1_Send(UsedDay_02);    //‰∏≤Âè£ÂèëÈÄÅ Â∑≤‰ΩøÁî®Â§©Êï∞_02
 265   1        Uart1_Send(WaterTDS_01);   //‰∏≤Âè£ÂèëÈÄÅ Á∫ØÊ∞¥TDSÂÄº_01
 266   1        Uart1_Send(WaterTDS_02);   //‰∏≤Âè£ÂèëÈÄÅ Á∫ØÊ∞¥TDSÂÄº_02
 267   1        Uart1_Send(GPRSSignal);    //‰∏≤Âè£ÂèëÈÄÅ GPRS‰ø°Âè∑Âº∫Â∫¶
 268   1        Uart1_Send(ICCID1_01);     //‰∏≤Âè£ÂèëÈÄÅ ICCID1_01
 269   1        Uart1_Send(ICCID1_02);     //‰∏≤Âè£ÂèëÈÄÅ ICCID1_02
 270   1        Uart1_Send(ICCID2_01);     //‰∏≤Âè£ÂèëÈÄÅ ICCID2_01
 271   1        Uart1_Send(ICCID2_02);     //‰∏≤Âè£ÂèëÈÄÅ ICCID2_02
 272   1        Uart1_Send(ICCID3_01);     //‰∏≤Âè£ÂèëÈÄÅ ICCID3_01
 273   1        Uart1_Send(ICCID3_02);     //‰∏≤Âè£ÂèëÈÄÅ ICCID3_02
 274   1        Uart1_Send(ICCID4_01);     //‰∏≤Âè£ÂèëÈÄÅ ICCID4_01
 275   1        Uart1_Send(ICCID4_02);     //‰∏≤Âè£ÂèëÈÄÅ ICCID4_02
 276   1        Uart1_Send(ICCID5_01);     //‰∏≤Âè£ÂèëÈÄÅ ICCID5_01
 277   1        Uart1_Send(ICCID5_02);     //‰∏≤Âè£ÂèëÈÄÅ ICCID5_02
 278   1        Uart1_Send(Check_01);    //‰∏≤Âè£ÂèëÈÄÅ Ê†°È™å‰Ωç_01
 279   1        Uart1_Send(Check_02);    //‰∏≤Âè£ÂèëÈÄÅ Ê†°È™å‰Ωç_02
 280   1        Order = COMMAND_HEARTBEATPACKET;
 281   1        //Uart1_Send(0x1A); //‰∏≤Âè£ÂèëÈÄÅ 0x1A
 282   1        while (1)
 283   1        {
 284   2          if (RECV_Return("OK", NULL) == True) //Ê£ÄÊµãÊé•ÂèóÁºìÂÜ≤Âå∫‰∏≠ÊòØÂê¶ÂåÖÂê´"SEND OK"ÔºåÂ¶ÇÊûú‰∏çÂåÖÂê´Êâ
             -ßË°å‰∏ãÂàóËØ≠Âè•
 285   2          {
 286   3            Send_OK_Flag = True;
 287   3            return;
 288   3          }
 289   2        }
 290   1      }
 291          void GPRS_SendHeartPacket(void)
 292          {
 293   1        int Send_Num = 0;
 294   1        Clear_Buf(Rx_Buffer_AT);
C51 COMPILER V9.59.0.0   GPRS                                                              09/26/2018 15:39:21 PAGE 6   

 295   1        Send_OK_Flag = False;
 296   1        DeviceID_01 = IapRead(EEPROM_DeviceID);
 297   1        DeviceID_02 = IapRead(EEPROM_DeviceID + 1);
 298   1        DeviceID_03 = IapRead(EEPROM_DeviceID + 2);
 299   1        DeviceID_04 = IapRead(EEPROM_DeviceID + 3);
 300   1        Uart1_Send_Data("AT+CIPSEND=4\r\n"); //‰∏≤Âè£ÂèëÈÄÅ "AT+CIPSEND"
 301   1        //Delay_MS(2000);             //Âª∂Êó∂500ÊØ´ÁßíÔºà0.5ÁßíÔºâ
 302   1        while (1) //Ê£ÄÊµãÊé•ÂèóÁºìÂÜ≤Âå∫‰∏≠ÊòØÂê¶ÂåÖÂê´">"ÔºåÂ¶ÇÊûú‰∏çÂåÖÂê´ÊâßË°å‰∏ãÂàóËØ≠Âè•
 303   1        {
 304   2          if (RECV_Return(">", NULL) == True)
 305   2          {
 306   3            goto SENDHEARTFLAG;
 307   3          }
 308   2          if ((RECV_Return("ERROR", NULL) == True) || (RECV_Return_Special("ERROR", NULL) == True))
 309   2          {
 310   3            GPRS_ConnectClose();
 311   3            GPRS_ConnectCreat(IP, Port);
 312   3            IapRead(EEPROM_DeviceMode);
 313   3            IapRead(EEPROM_DeviceStatus);
 314   3            GPRS_SendData(COMMAND_HEARTBEATPACKET, DeviceMode, DeviceStatus);
 315   3            Order = COMMAND_HEARTBEATPACKET;
 316   3            Clear_Buf(Rx_Buffer_AT);
 317   3            Clear_Buf(Rx_Buffer);
 318   3          }
 319   2        }
 320   1      SENDHEARTFLAG:
 321   1        Clear_Buf(Rx_Buffer_AT);
 322   1        Uart1_Send(DeviceID_01); //‰∏≤Âè£ÂèëÈÄÅ ÂøÉË∑≥ÂëΩ‰ª§
 323   1        Uart1_Send(DeviceID_02); //‰∏≤Âè£ÂèëÈÄÅ 0x00
 324   1        Uart1_Send(DeviceID_03); //‰∏≤Âè£ÂèëÈÄÅ 0x00
 325   1        Uart1_Send(DeviceID_04); //‰∏≤Âè£ÂèëÈÄÅ 0x00
 326   1        //Uart1_Send(0x1A); //‰∏≤Âè£ÂèëÈÄÅ 0x1A
 327   1        while (1)
 328   1        {
 329   2          if (RECV_Return("OK", NULL) == True) //Ê£ÄÊµãÊé•ÂèóÁºìÂÜ≤Âå∫‰∏≠ÊòØÂê¶ÂåÖÂê´"SEND OK"ÔºåÂ¶ÇÊûú‰∏çÂåÖÂê´Êâ
             -ßË°å‰∏ãÂàóËØ≠Âè•
 330   2          {
 331   3            Send_OK_Flag = True;
 332   3            return;
 333   3          }
 334   2        }
 335   1      }
 336          
 337          void GPRS_Signal(void)
 338          {
 339   1        char Signal[3];
 340   1        Clear_Buf(Rx_Buffer_AT);
 341   1        Uart1_Send_Data("AT+CSQ\r\n");
 342   1        Delay_MS(500);
 343   1        //Uart2_Send_Data(Rx_Buffer);
 344   1        while (RECV_Return("+CSQ: ", NULL) == False)
 345   1        {
 346   2          Clear_Buf(Rx_Buffer_AT);
 347   2          Uart1_Send_Data("AT+CSQ\r\n");
 348   2          Delay_MS(500);
 349   2          //Uart2_Send_Data(Rx_Buffer);
 350   2        }
 351   1        GPRSSignal = atoi(strncpy(Signal, strchr(Rx_Buffer_AT, ' '), 3));
 352   1        IapErase(EEPROM_GPRSSignal);
 353   1        IapProgram(EEPROM_GPRSSignal, GPRSSignal);
 354   1      }
 355          
C51 COMPILER V9.59.0.0   GPRS                                                              09/26/2018 15:39:21 PAGE 7   

 356          void GPRS_ICCID(void)
 357          {
 358   1        unsigned char Signal[21] = {0x00};
 359   1        char Temp[3] = {0x00, 0x00, 0x00};
 360   1        Clear_Buf(Rx_Buffer_AT);
 361   1        Uart1_Send_Data("AT+ICCID\r\n");
 362   1        Delay_MS(500);
 363   1        while (RECV_Return("+ICCID: ", NULL) == False)
 364   1        {
 365   2          Clear_Buf(Rx_Buffer_AT);
 366   2          Uart1_Send_Data("AT+ICCID\r\n");
 367   2          Delay_MS(500);
 368   2        }
 369   1        strncpy(Signal, strchr(Rx_Buffer_AT, ' ') + 1, 20);
 370   1        strncpy(Temp, Signal + 0, 2);
 371   1        ICCID1_01 = Hex_to_Int(Temp);
 372   1        IapErase(EEPROM_ICCID);
 373   1        IapProgram(EEPROM_ICCID, ICCID1_01);
 374   1      
 375   1        strncpy(Temp, Signal + 2, 2);
 376   1        ICCID1_02 = Hex_to_Int(Temp);
 377   1        IapProgram(EEPROM_ICCID + 1, ICCID1_02);
 378   1      
 379   1        strncpy(Temp, Signal + 4, 2);
 380   1        ICCID2_01 = Hex_to_Int(Temp);
 381   1        IapProgram(EEPROM_ICCID + 2, ICCID2_01);
 382   1      
 383   1        strncpy(Temp, Signal + 6, 2);
 384   1        ICCID2_02 = Hex_to_Int(Temp);
 385   1        IapProgram(EEPROM_ICCID + 3, ICCID2_02);
 386   1      
 387   1        strncpy(Temp, Signal + 8, 2);
 388   1        ICCID3_01 = Hex_to_Int(Temp);
 389   1        IapProgram(EEPROM_ICCID + 4, ICCID3_01);
 390   1      
 391   1        strncpy(Temp, Signal + 10, 2);
 392   1        ICCID3_02 = Hex_to_Int(Temp);
 393   1        IapProgram(EEPROM_ICCID + 5, ICCID3_02);
 394   1      
 395   1        strncpy(Temp, Signal + 12, 2);
 396   1        ICCID4_01 = Hex_to_Int(Temp);
 397   1        IapProgram(EEPROM_ICCID + 6, ICCID4_01);
 398   1      
 399   1        strncpy(Temp, Signal + 14, 2);
 400   1        ICCID4_02 = Hex_to_Int(Temp);
 401   1        IapProgram(EEPROM_ICCID + 7, ICCID4_02);
 402   1      
 403   1        strncpy(Temp, Signal + 16, 2);
 404   1        ICCID5_01 = Hex_to_Int(Temp);
 405   1        IapProgram(EEPROM_ICCID + 8, ICCID5_01);
 406   1      
 407   1        strncpy(Temp, Signal + 18, 2);
 408   1        ICCID5_02 = Hex_to_Int(Temp);
 409   1        IapProgram(EEPROM_ICCID + 9, ICCID5_02);
 410   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2550    ----
   CONSTANT SIZE    =    263    ----
   XDATA SIZE       =   ----       4
   PDATA SIZE       =   ----    ----
C51 COMPILER V9.59.0.0   GPRS                                                              09/26/2018 15:39:21 PAGE 8   

   DATA SIZE        =   ----      52
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
